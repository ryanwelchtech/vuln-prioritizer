"""
Vulnerability model for storing CVE data with risk scores.
"""
from datetime import datetime
from typing import Optional, List
from sqlalchemy import String, Float, Boolean, DateTime, Text, Integer, JSON
from sqlalchemy.orm import Mapped, mapped_column

from app.core.database import Base


class Vulnerability(Base):
    """Vulnerability/CVE model with risk scoring data."""

    __tablename__ = "vulnerabilities"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    cve_id: Mapped[str] = mapped_column(String(20), unique=True, index=True, nullable=False)

    # CVE Details
    description: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    published_date: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)
    last_modified: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)

    # CVSS Scores
    cvss_v3_score: Mapped[Optional[float]] = mapped_column(Float, nullable=True)
    cvss_v3_vector: Mapped[Optional[str]] = mapped_column(String(100), nullable=True)
    cvss_v2_score: Mapped[Optional[float]] = mapped_column(Float, nullable=True)

    # EPSS Data
    epss_score: Mapped[Optional[float]] = mapped_column(Float, nullable=True)
    epss_percentile: Mapped[Optional[float]] = mapped_column(Float, nullable=True)
    epss_updated: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)

    # CISA KEV
    in_kev: Mapped[bool] = mapped_column(Boolean, default=False)
    kev_date_added: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)
    kev_due_date: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)

    # CWE
    cwe_ids: Mapped[Optional[List[str]]] = mapped_column(JSON, nullable=True)

    # Risk Score (calculated)
    risk_score: Mapped[Optional[float]] = mapped_column(Float, nullable=True, index=True)
    severity: Mapped[Optional[str]] = mapped_column(String(20), nullable=True, index=True)

    # Affected Products
    affected_products: Mapped[Optional[List[dict]]] = mapped_column(JSON, nullable=True)

    # References
    references: Mapped[Optional[List[str]]] = mapped_column(JSON, nullable=True)

    # Remediation
    remediation_status: Mapped[str] = mapped_column(String(20), default="open", index=True)
    remediation_notes: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    remediation_due_date: Mapped[Optional[datetime]] = mapped_column(DateTime, nullable=True)
    jira_ticket_id: Mapped[Optional[str]] = mapped_column(String(50), nullable=True)

    # Metadata
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
    updated_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    def calculate_risk_score(self, asset_criticality: float = 1.0, network_reachability: float = 1.0) -> float:
        """
        Calculate risk score based on CVSS, EPSS, KEV, and context factors.

        Risk Score = Base_Score * Exploit_Factor * Context_Factor

        Base_Score: CVSS v3.1 normalized (0-1)
        Exploit_Factor: EPSS * KEV multiplier (1.0-2.0)
        Context_Factor: Asset criticality * Network reachability (0.5-1.5)
        """
        # Base score from CVSS
        base = (self.cvss_v3_score or 0) / 10.0

        # Exploit factor from EPSS and KEV
        exploit_factor = self.epss_score or 0.1
        if self.in_kev:
            exploit_factor = min(exploit_factor * 2.0, 1.0)

        # Context factor
        context_factor = (asset_criticality * 0.5 + network_reachability * 0.5)

        # Final score (0-100)
        self.risk_score = min(base * exploit_factor * context_factor * 100, 100)
        self._set_severity()

        return self.risk_score

    def _set_severity(self):
        """Set severity based on risk score."""
        if self.risk_score is None:
            self.severity = "unknown"
        elif self.risk_score >= 70:
            self.severity = "critical"
        elif self.risk_score >= 40:
            self.severity = "high"
        elif self.risk_score >= 20:
            self.severity = "medium"
        else:
            self.severity = "low"
